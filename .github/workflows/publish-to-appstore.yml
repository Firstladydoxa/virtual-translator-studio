name: Publish to TNI App Store

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

env:
  # App Store Configuration
  APP_CATEGORY: "Productivity"
  APP_SHORT_DESC: "Professional real-time translation studio with live streaming support"
  APP_FULL_DESC: |
    Virtual Translator Studio - Professional Translation Platform
    
    Transform your translation workflow with our cutting-edge mobile app designed specifically for professional translators.
    
    KEY FEATURES:
    üåç Real-Time Translation - Support for multiple language pairs with instant preview
    üéôÔ∏è Live Streaming Translation - Real-time audio translation during live streams
    üìù Professional Translation Management - Manage projects and track progress
    üí¨ Collaborative Features - Push notifications and in-app messaging
    üîê Secure & Reliable - End-to-end encryption and cloud backup
    üì± Mobile-Optimized Interface - Intuitive touch controls and responsive design
    
    Perfect for professional translators, translation agencies, content creators, and live event translators.
  
  # Build Configuration (auto-detected from build.gradle, but can override)
  GRADLE_TASK: "assembleRelease"
  BUILD_DIR: "android"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend-react/package-lock.json'
      
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Install dependencies
        working-directory: ./frontend-react
        run: npm ci
      
      - name: Build React app
        working-directory: ./frontend-react
        run: npm run build
      
      - name: Sync Capacitor
        working-directory: ./frontend-react
        run: npx cap sync android
      
      - name: Decode keystore
        working-directory: ./frontend-react/android
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > release.keystore
      
      - name: Create keystore.properties
        working-directory: ./frontend-react/android
        run: |
          cat > keystore.properties << EOF
          storeFile=release.keystore
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF
      
      - name: Build release APK
        working-directory: ./frontend-react/android
        run: |
          chmod +x ./gradlew
          ./gradlew ${{ env.GRADLE_TASK }} --no-daemon
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}
      
      - name: Extract version info
        id: version
        working-directory: ./frontend-react/android/app
        run: |
          VERSION_NAME=$(grep 'versionName' build.gradle | sed 's/.*versionName "\(.*\)".*/\1/')
          VERSION_CODE=$(grep 'versionCode' build.gradle | sed 's/.*versionCode \(.*\)/\1/')
          PACKAGE_NAME=$(grep 'applicationId' build.gradle | sed 's/.*applicationId "\(.*\)".*/\1/')
          APP_NAME=$(grep 'app_name' src/main/res/values/strings.xml | sed 's/.*<string name="app_name">\(.*\)<\/string>/\1/')
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
      
      - name: Find APK file
        id: apk
        working-directory: ./frontend-react/android
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -n 1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK: $APK_PATH"
      
      - name: Upload to TNI App Store
        run: |
          curl -X POST "${{ secrets.APPSTORE_API_URL }}/apps/publish" \
            -H "Authorization: Bearer ${{ secrets.APPSTORE_API_KEY }}" \
            -H "Content-Type: multipart/form-data" \
            -F "apk=@./frontend-react/android/${{ steps.apk.outputs.apk_path }}" \
            -F "package_name=${{ steps.version.outputs.package_name }}" \
            -F "app_name=${{ steps.version.outputs.app_name }}" \
            -F "version_name=${{ steps.version.outputs.version_name }}" \
            -F "version_code=${{ steps.version.outputs.version_code }}" \
            -F "category=${{ env.APP_CATEGORY }}" \
            -F "short_description=${{ env.APP_SHORT_DESC }}" \
            -F "full_description=${{ env.APP_FULL_DESC }}" \
            -F "changelog=See GitHub release notes for v${{ steps.version.outputs.version_name }}"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./frontend-react/android/${{ steps.apk.outputs.apk_path }}
          body: |
            ## üì± Virtual Translator Studio v${{ steps.version.outputs.version_name }}
            
            **Package:** ${{ steps.version.outputs.package_name }}
            **Version Code:** ${{ steps.version.outputs.version_code }}
            
            ### üöÄ What's New
            <!-- Add release notes here -->
            
            ### üì• Download
            - Download APK from Assets below
            - Or get it from TNI App Store
            
            ### üìä Build Info
            - Built on: ${{ github.run_id }}
            - Commit: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Notify success
        if: success()
        run: |
          echo "‚úÖ Successfully published to TNI App Store!"
          echo "üì± App: ${{ steps.version.outputs.app_name }}"
          echo "üì¶ Version: ${{ steps.version.outputs.version_name }} (code: ${{ steps.version.outputs.version_code }})"
          echo "üÜî Package: ${{ steps.version.outputs.package_name }}"
      
      - name: Notify failure
        if: failure()
        run: |
          echo "‚ùå Failed to publish to TNI App Store"
          echo "Check the logs above for details"
